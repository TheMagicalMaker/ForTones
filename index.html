<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn Chinese Tones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .tone-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .tone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .tone-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--accent-color);
        }

        .tone-card.tone1::before { background: #e74c3c; }
        .tone-card.tone2::before { background: #f39c12; }
        .tone-card.tone3::before { background: #27ae60; }
        .tone-card.tone4::before { background: #3498db; }

        .tone-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .tone1 .tone-number { color: #e74c3c; }
        .tone2 .tone-number { color: #f39c12; }
        .tone3 .tone-number { color: #27ae60; }
        .tone4 .tone-number { color: #3498db; }

        .tone-name {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .tone-description {
            font-size: 1em;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .tone-visual {
            height: 80px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tone-line {
            width: 200px;
            height: 4px;
            background: var(--accent-color);
            position: relative;
            border-radius: 2px;
        }

        .tone1 .tone-line {
            background: #e74c3c;
            transform: none;
        }

        .tone2 .tone-line {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            transform: rotate(-30deg);
        }

        .tone3 .tone-line {
            width: 0;
            height: 0;
            border: none;
            position: relative;
        }

        .tone3 .tone-line::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 30px;
            border: 4px solid #27ae60;
            border-top: none;
            border-right: none;
            border-radius: 0 0 0 20px;
            transform: rotate(-35deg) translateX(-20px) translateY(-10px);
        }

        .tone4 .tone-line {
            background: linear-gradient(45deg, #3498db, #2980b9);
            transform: rotate(15deg);
        }

        .example-word {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .chinese-char {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .pinyin {
            font-size: 1.2em;
            color: #7f8c8d;
            margin: 5px 0;
        }

        .meaning {
            font-size: 0.9em;
            color: #95a5a6;
        }

        .quiz-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .quiz-title {
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
            color: #2c3e50;
        }

        .tones-section {
            text-align: center;
            margin: 40px 0 20px 0;
        }

        .section-title {
            font-size: 2em;
            color: white;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .quiz-progress {
            text-align: center;
            font-size: 1.1em;
            color: #7f8c8d;
            margin-bottom: 20px;
            padding: 8px 16px;
            background: #ecf0f1;
            border-radius: 20px;
            display: inline-block;
            margin-left: 50%;
            transform: translateX(-50%);
            font-weight: 500;
        }

        .quiz-question {
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            color: #34495e;
        }

        .character-display {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .character-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .big-character {
            font-size: 4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .character-pinyin {
            font-size: 1.5em;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .play-character-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-character-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .play-character-btn:active {
            transform: translateY(0);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quiz-option {
            padding: 15px 20px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .quiz-option:hover {
            border-color: #3498db;
            background: #ebf3fd;
        }

        .quiz-option.correct {
            border-color: #27ae60;
            background: #d5f4e6;
            color: #27ae60;
        }

        .quiz-option.incorrect {
            border-color: #e74c3c;
            background: #ffeaea;
            color: #e74c3c;
        }

        .quiz-result {
            text-align: center;
            font-size: 1.2em;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        .quiz-result.correct {
            background: #d5f4e6;
            color: #27ae60;
        }

        .quiz-result.incorrect {
            background: #ffeaea;
            color: #e74c3c;
        }

        .next-question {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .next-question:hover {
            background: #2980b9;
        }

        .practice-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .tone-practice {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .practice-tone {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }

        .practice-tone:hover {
            transform: scale(1.1);
        }

        .practice-tone.active {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .practice-word {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .tone-info {
            font-size: 1em;
            color: #666;
            margin-top: 5px;
        }

        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .record-btn, .play-btn, .next-word-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .record-btn.start {
            background: #27ae60;
            color: white;
        }

        .record-btn.stop {
            background: #e74c3c;
            color: white;
            animation: pulse 1s infinite;
        }

        .play-btn {
            background: #3498db;
            color: white;
        }

        .play-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .next-word-btn {
            background: #f39c12;
            color: white;
        }

        .record-btn:hover:not(.stop), .play-btn:hover:not(:disabled), .next-word-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .recording-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            color: #666;
            font-weight: 500;
        }

        .recording-status.recording {
            background: #d4edda;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .wave-visualization {
            height: 60px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wave-bars {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 40px;
        }

        .wave-bar {
            width: 4px;
            background: linear-gradient(to top, #3498db, #5dade2);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .feedback-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feedback-section.show {
            opacity: 1;
        }

        .feedback-section.good {
            background: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .tone-visualization-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tone-visualization-container h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        #tone-canvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #fafafa;
        }

        .tone-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .legend-color.reference {
            background: #3498db;
        }

        .legend-color.recording {
            background: #e74c3c;
        }

        .quiz-report {
            text-align: center;
            padding: 20px;
        }

        .quiz-report h3 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .report-summary {
            margin-bottom: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
        }

        .score-number {
            font-size: 2em;
            font-weight: bold;
        }

        .score-text {
            font-size: 0.9em;
        }

        .feedback {
            font-size: 1.2em;
            color: #2c3e50;
            margin: 0;
        }

        .report-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
        }

        .stat-label {
            display: block;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .tone-breakdown {
            margin-bottom: 30px;
        }

        .tone-breakdown h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .tone-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .tone-stat {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tone-label {
            flex: 0 0 150px;
            text-align: left;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .tone-bar {
            flex: 1;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .tone-progress {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .tone-percentage {
            flex: 0 0 40px;
            text-align: right;
            font-weight: bold;
            color: #27ae60;
        }

        .detailed-results {
            margin-bottom: 30px;
        }

        .detailed-results h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .results-table {
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 600px;
            margin: 0 auto;
        }

        .result-row {
            display: grid;
            grid-template-columns: 30px 40px 80px 1fr 80px 50px;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .result-row.correct {
            background: #d5f4e6;
        }

        .result-row.incorrect {
            background: #ffeaea;
        }

        .result-char {
            font-size: 1.2em;
            font-weight: bold;
        }

        .result-time {
            text-align: right;
            color: #7f8c8d;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .quiz-action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn {
            background: #3498db;
            color: white;
        }

        .continue-btn {
            background: #27ae60;
            color: white;
        }

        .quiz-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .practice-report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .practice-report-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .practice-summary {
            margin-bottom: 30px;
        }

        .practice-score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: white;
        }

        .practice-score-number {
            font-size: 1.5em;
            font-weight: bold;
        }

        .practice-score-text {
            font-size: 0.8em;
        }

        .practice-analysis {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .analysis-label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .pitch-visualization {
            height: 40px;
            background: #ecf0f1;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .pitch-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
            transform-origin: left center;
        }

        .practice-feedback {
            background: #e8f5e8;
            color: #27ae60;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .practice-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .practice-action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .practice-action-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .tones-grid {
                grid-template-columns: 1fr;
            }
            
            .tone-card {
                padding: 20px;
            }
            
            .quiz-section, .practice-section {
                padding: 20px;
            }

            .recording-controls {
                flex-direction: column;
                align-items: center;
            }

            .record-btn, .play-btn, .next-word-btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Master Chinese Tones</h1>
            <p>Master the four fundamental tones of Mandarin Chinese</p>
        </div>

        <div class="quiz-section">
            <h2 class="quiz-title">👂 Can you hear the tones?</h2>
            <div class="quiz-progress" id="quiz-progress">Question 1 of 8</div>
            <div id="quiz-content">
                <div class="quiz-question" id="quiz-question">
                    Which tone does this character use: <strong id="quiz-char">妈</strong> (mother)?
                </div>
                <div class="character-display">
                    <div class="character-info">
                        <div class="big-character" id="big-char">妈</div>
                        <div class="character-pinyin" id="char-pinyin" style="display: none;">mā</div>
                        <button class="play-character-btn" id="play-char-btn" onclick="playCharacterTone()">🔊 Play Sound</button>
                    </div>
                </div>
                <div class="quiz-options" id="quiz-options">
                    <div class="quiz-option" onclick="selectAnswer(1)">1st Tone (High Level)</div>
                    <div class="quiz-option" onclick="selectAnswer(2)">2nd Tone (Rising)</div>
                    <div class="quiz-option" onclick="selectAnswer(3)">3rd Tone (Dipping)</div>
                    <div class="quiz-option" onclick="selectAnswer(4)">4th Tone (Falling)</div>
                </div>
                <div id="quiz-result" class="quiz-result" style="display: none;"></div>
                <button id="next-question" class="next-question" style="display: none;">Next Question</button>
            </div>
        </div>

        <div class="tones-section">
            <h2 class="section-title">🎵 Now, let's hear the 4 tones</h2>
        </div>

        <div class="tones-grid">
            <div class="tone-card tone1" onclick="playTone(1)">
                <div class="tone-number">1st</div>
                <div class="tone-name">High Level (阴平)</div>
                <div class="tone-description">A steady, high pitch that stays constant throughout the syllable.</div>
                <div class="tone-visual">
                    <div class="tone-line"></div>
                </div>
                <div class="example-word">
                    <div class="chinese-char">妈</div>
                    <div class="pinyin">mā</div>
                    <div class="meaning">mother</div>
                </div>
            </div>

            <div class="tone-card tone2" onclick="playTone(2)">
                <div class="tone-number">2nd</div>
                <div class="tone-name">Rising (阳平)</div>
                <div class="tone-description">Starts at a middle pitch and rises to a high pitch, like asking a question.</div>
                <div class="tone-visual">
                    <div class="tone-line"></div>
                </div>
                <div class="example-word">
                    <div class="chinese-char">麻</div>
                    <div class="pinyin">má</div>
                    <div class="meaning">hemp, numb</div>
                </div>
            </div>

            <div class="tone-card tone3" onclick="playTone(3)">
                <div class="tone-number">3rd</div>
                <div class="tone-name">Dipping (上声)</div>
                <div class="tone-description">Starts mid, dips low, then rises back up. Like saying "really?" with skepticism.</div>
                <div class="tone-visual">
                    <div class="tone-line"></div>
                </div>
                <div class="example-word">
                    <div class="chinese-char">马</div>
                    <div class="pinyin">mǎ</div>
                    <div class="meaning">horse</div>
                </div>
            </div>

            <div class="tone-card tone4" onclick="playTone(4)">
                <div class="tone-number">4th</div>
                <div class="tone-name">Falling (去声)</div>
                <div class="tone-description">Starts high and drops sharply to a low pitch, like a firm command.</div>
                <div class="tone-visual">
                    <div class="tone-line"></div>
                </div>
                <div class="example-word">
                    <div class="chinese-char">骂</div>
                    <div class="pinyin">mà</div>
                    <div class="meaning">to scold</div>
                </div>
            </div>
        </div>

        <div class="practice-section">
            <h2>🎤 Can you say the tones?</h2>
            <p>Click on a tone number to hear how it sounds, then practice speaking!</p>
            <div class="tone-practice">
                <div class="practice-tone" onclick="playTone(1)">1</div>
                <div class="practice-tone" onclick="playTone(2)">2</div>
                <div class="practice-tone" onclick="playTone(3)">3</div>
                <div class="practice-tone" onclick="playTone(4)">4</div>
            </div>
            <p><em>Click each tone to hear an example sound pattern</em></p>
            
            <div class="practice-word">
                <div class="chinese-char" id="practice-char">妈</div>
                <div class="pinyin" id="practice-pinyin">mā</div>
                <div class="meaning" id="practice-meaning">mother</div>
                <div class="tone-info" id="practice-tone-info">1st tone (High Level)</div>
            </div>
            
            <div class="recording-controls">
                <button id="record-btn" class="record-btn start" onclick="toggleRecording()">🎤 Start Recording</button>
                <button id="play-btn" class="play-btn" onclick="playRecording()" disabled>▶️ Play Recording</button>
                <button id="next-word-btn" class="next-word-btn" onclick="nextPracticeWord()">➡️ Next Word</button>
            </div>
            
            <div class="recording-status" id="recording-status">Ready to record - Press the microphone button to start</div>
            
            <div class="tone-visualization-container">
                <h4>Target Tone Pattern:</h4>
                <canvas id="tone-canvas" width="400" height="150"></canvas>
                <div class="tone-legend">
                    <span class="legend-item"><span class="legend-color reference"></span>Target Pattern</span>
                    <span class="legend-item"><span class="legend-color recording"></span>Your Voice</span>
                </div>
            </div>
            
            <div class="wave-visualization">
                <div id="wave-bars" class="wave-bars"></div>
            </div>
            
            <div id="feedback" class="feedback-section"></div>
            
            <div id="practice-report" class="practice-report-section" style="display: none;">
                <h3>📈 Practice Report</h3>
                <div class="practice-summary">
                    <div class="practice-score-circle">
                        <div class="practice-score-number" id="practice-score">0%</div>
                        <div class="practice-score-text">Tone Match</div>
                    </div>
                </div>
                <div class="practice-analysis">
                    <div class="analysis-item">
                        <span class="analysis-label">Your Pitch Pattern:</span>
                        <div class="pitch-visualization" id="user-pitch-pattern"></div>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">Target Pattern:</span>
                        <div class="pitch-visualization" id="target-pitch-pattern"></div>
                    </div>
                </div>
                <div class="practice-feedback" id="practice-feedback-text">
                    Great job! Keep practicing to improve your tone accuracy.
                </div>
                <div class="practice-actions">
                    <button class="practice-action-btn" onclick="tryAgainPractice()">🔄 Try Again</button>
                    <button class="practice-action-btn" onclick="nextPracticeWord()">➡️ Next Word</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Quiz data (base questions)
        const baseQuizData = [
            { char: '妈', pinyin: 'mā', meaning: 'mother', tone: 1 },
            { char: '麻', pinyin: 'má', meaning: 'hemp', tone: 2 },
            { char: '马', pinyin: 'mǎ', meaning: 'horse', tone: 3 },
            { char: '骂', pinyin: 'mà', meaning: 'to scold', tone: 4 },
            { char: '他', pinyin: 'tā', meaning: 'he/him', tone: 1 },
            { char: '茶', pinyin: 'chá', meaning: 'tea', tone: 2 },
            { char: '打', pinyin: 'dǎ', meaning: 'to hit', tone: 3 },
            { char: '大', pinyin: 'dà', meaning: 'big', tone: 4 }
        ];

        // Shuffled quiz data (will be randomized each time)
        let quizData = [];

        let currentQuestion = 0;
        let score = 0;
        let answered = false;
        
        // Quiz performance tracking
        let quizAnswers = [];
        let quizStartTime = null;
        let questionStartTime = null;

        // Audio context for tone generation
        let audioContext;
        let isAudioInitialized = false;

        // Recording variables
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let recordedAudio = null;
        let currentPracticeWord = 0;

        // Tone visualization variables
        let canvas;
        let ctx;
        let analyser;
        let pitchData = [];
        let animationId;

        // Shuffle function (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function initializeQuiz() {
            // Shuffle the quiz questions
            quizData = shuffleArray(baseQuizData);
            console.log('Quiz questions shuffled:', quizData.map(q => q.char));
        }

        function initAudio() {
            if (!isAudioInitialized) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                isAudioInitialized = true;
            }
        }

        function playTone(toneNumber) {
            initAudio();
            
            // Add visual feedback
            const toneCard = document.querySelector(`.tone${toneNumber}`);
            if (toneCard) {
                toneCard.classList.add('playing');
                setTimeout(() => toneCard.classList.remove('playing'), 500);
            }

            // Create oscillator for tone
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Set volume
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            const startTime = audioContext.currentTime;
            const duration = 1.0;
            
            // Define tone patterns
            switch(toneNumber) {
                case 1: // High level tone
                    oscillator.frequency.setValueAtTime(330, startTime); // E4
                    break;
                case 2: // Rising tone
                    oscillator.frequency.setValueAtTime(220, startTime); // A3
                    oscillator.frequency.exponentialRampToValueAtTime(330, startTime + duration); // to E4
                    break;
                case 3: // Dipping tone
                    oscillator.frequency.setValueAtTime(260, startTime); // C4
                    oscillator.frequency.exponentialRampToValueAtTime(196, startTime + duration/2); // to G3
                    oscillator.frequency.exponentialRampToValueAtTime(294, startTime + duration); // to D4
                    break;
                case 4: // Falling tone
                    oscillator.frequency.setValueAtTime(330, startTime); // E4
                    oscillator.frequency.exponentialRampToValueAtTime(165, startTime + duration); // to E3
                    break;
            }
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        function playCharacterTone() {
            const question = quizData[currentQuestion];
            if (question && question.tone) {
                console.log('Playing tone for character:', question.char, 'tone:', question.tone);
                playTone(question.tone);
                
                // Visual feedback
                const playBtn = document.getElementById('play-char-btn');
                const bigChar = document.getElementById('big-char');
                
                if (playBtn) {
                    playBtn.style.background = '#27ae60';
                    playBtn.textContent = '🎵 Playing...';
                    setTimeout(() => {
                        playBtn.style.background = '#3498db';
                        playBtn.textContent = '🔊 Play Sound';
                    }, 1000);
                }
                
                if (bigChar) {
                    bigChar.style.transform = 'scale(1.1)';
                    bigChar.style.color = '#e74c3c';
                    setTimeout(() => {
                        bigChar.style.transform = 'scale(1)';
                        bigChar.style.color = '#2c3e50';
                    }, 1000);
                }
            }
        }

        function loadQuestion() {
            console.log('=== loadQuestion called ===');
            console.log('currentQuestion index:', currentQuestion);
            console.log('Display will show: Question', currentQuestion + 1, 'of', quizData.length);
            
            // Start timing for this question
            questionStartTime = Date.now();
            
            // Initialize quiz start time on first question
            if (currentQuestion === 0 && !quizStartTime) {
                quizStartTime = Date.now();
            }
            
            const question = quizData[currentQuestion];
            console.log('Question data:', question);
            
            // Update progress counter
            const progressDiv = document.getElementById('quiz-progress');
            if (progressDiv) {
                const displayText = `Question ${currentQuestion + 1} of ${quizData.length}`;
                progressDiv.textContent = displayText;
                console.log('Progress updated to:', displayText);
            }
            
            const charElement = document.getElementById('quiz-char');
            const questionElement = document.getElementById('quiz-question');
            
            console.log('Updating char element with:', question.char);
            console.log('Updating question element with meaning:', question.meaning);
            
            if (charElement) {
                charElement.textContent = question.char;
            } else {
                console.error('quiz-char element not found!');
            }
            
            if (questionElement) {
                questionElement.innerHTML = `Which tone does this character use: <strong>${question.char}</strong> (${question.meaning})?`;
            } else {
                console.error('quiz-question element not found!');
            }

            // Update character display
            const bigCharElement = document.getElementById('big-char');
            const pinyinElement = document.getElementById('char-pinyin');
            
            if (bigCharElement) {
                bigCharElement.textContent = question.char;
            }
            
            if (pinyinElement) {
                pinyinElement.textContent = question.pinyin;
                pinyinElement.style.display = 'none'; // Hide pinyin until user answers
            }
            
            // Reset options
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.className = 'quiz-option';
            });
            
            document.getElementById('quiz-result').style.display = 'none';
            document.getElementById('next-question').style.display = 'none';
            answered = false;
        }

        function selectAnswer(selectedTone) {
            if (answered) return;
            
            answered = true;
            const question = quizData[currentQuestion];
            const options = document.querySelectorAll('.quiz-option');
            const resultDiv = document.getElementById('quiz-result');
            const nextBtn = document.getElementById('next-question');
            
            // Track answer performance
            const responseTime = questionStartTime ? Date.now() - questionStartTime : 0;
            const isCorrect = selectedTone === question.tone;
            
            quizAnswers.push({
                questionIndex: currentQuestion,
                character: question.char,
                pinyin: question.pinyin,
                meaning: question.meaning,
                correctTone: question.tone,
                selectedTone: selectedTone,
                isCorrect: isCorrect,
                responseTime: responseTime
            });
            
            options.forEach((option, index) => {
                const toneNum = index + 1;
                if (toneNum === question.tone) {
                    option.classList.add('correct');
                } else if (toneNum === selectedTone && selectedTone !== question.tone) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selectedTone === question.tone) {
                score++;
                resultDiv.textContent = `Correct! 🎉 "${question.char}" (${question.pinyin}) is ${question.tone}${getOrdinalSuffix(question.tone)} tone.`;
                resultDiv.className = 'quiz-result correct';
            } else {
                resultDiv.textContent = `Not quite. "${question.char}" (${question.pinyin}) is ${question.tone}${getOrdinalSuffix(question.tone)} tone, not ${selectedTone}${getOrdinalSuffix(selectedTone)} tone.`;
                resultDiv.className = 'quiz-result incorrect';
            }
            
            resultDiv.style.display = 'block';
            
            // Show pinyin after user selects an answer
            const pinyinElement = document.getElementById('char-pinyin');
            if (pinyinElement) {
                pinyinElement.style.display = 'block';
            }
            
            if (nextBtn) {
                console.log('Showing next question button');
                nextBtn.style.display = 'inline-block';
            } else {
                console.error('Next question button not found!');
            }
        }

        function getOrdinalSuffix(num) {
            const suffixes = ['', 'st', 'nd', 'rd', 'th'];
            return suffixes[num] || 'th';
        }

        let isProcessingNext = false;
        
        function nextQuestion() {
            console.log('=== nextQuestion function called ===');
            
            if (isProcessingNext) {
                console.log('Already processing next question, ignoring...');
                return;
            }
            
            isProcessingNext = true;
            console.log('Current question index:', currentQuestion);
            console.log('Total questions:', quizData.length);
            console.log('Current score:', score);
            
            currentQuestion++;
            console.log('After increment, currentQuestion:', currentQuestion);
            
            if (currentQuestion >= quizData.length) {
                // Quiz completed
                console.log('Quiz completed - showing final screen');
                showQuizReport();
            } else {
                console.log('Loading next question index:', currentQuestion);
                loadQuestion();
            }
            
            setTimeout(() => {
                isProcessingNext = false;
            }, 100);
        }

        function showQuizReport() {
            const totalTime = quizStartTime ? Date.now() - quizStartTime : 0;
            const averageTime = quizAnswers.length > 0 ? totalTime / quizAnswers.length : 0;
            const correctAnswers = quizAnswers.filter(answer => answer.isCorrect).length;
            const percentage = Math.round((correctAnswers / quizData.length) * 100);
            
            // Analyze performance by tone
            const toneStats = {};
            for (let i = 1; i <= 4; i++) {
                const toneQuestions = quizAnswers.filter(answer => answer.correctTone === i);
                const toneCorrect = toneQuestions.filter(answer => answer.isCorrect).length;
                toneStats[i] = {
                    total: toneQuestions.length,
                    correct: toneCorrect,
                    percentage: toneQuestions.length > 0 ? Math.round((toneCorrect / toneQuestions.length) * 100) : 0
                };
            }
            
            // Generate performance feedback
            let feedback = '';
            if (percentage >= 90) {
                feedback = '🏆 Excellent! You have mastered Chinese tone recognition!';
            } else if (percentage >= 75) {
                feedback = '👍 Great job! You have a good grasp of Chinese tones.';
            } else if (percentage >= 50) {
                feedback = '📚 Good progress! Keep practicing to improve your tone recognition.';
            } else {
                feedback = '💪 Keep practicing! Tone recognition takes time to master.';
            }
            
            // Find most challenging tones
            const sortedTones = Object.entries(toneStats)
                .sort((a, b) => a[1].percentage - b[1].percentage)
                .slice(0, 2);
            
            const toneNames = {
                1: '1st Tone (High Level)',
                2: '2nd Tone (Rising)', 
                3: '3rd Tone (Dipping)',
                4: '4th Tone (Falling)'
            };
            
            let reportHTML = `
                <div class="quiz-report">
                    <h3>📊 Your Quiz Report</h3>
                    
                    <div class="report-summary">
                        <div class="score-circle">
                            <div class="score-number">${percentage}%</div>
                            <div class="score-text">${correctAnswers}/${quizData.length} correct</div>
                        </div>
                        <p class="feedback">${feedback}</p>
                    </div>
                    
                    <div class="report-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Time:</span>
                            <span class="stat-value">${Math.round(totalTime / 1000)}s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg per Question:</span>
                            <span class="stat-value">${Math.round(averageTime / 1000)}s</span>
                        </div>
                    </div>
                    
                    <div class="tone-breakdown">
                        <h4>Performance by Tone:</h4>
                        <div class="tone-stats">`;
            
            for (let i = 1; i <= 4; i++) {
                const stats = toneStats[i];
                reportHTML += `
                    <div class="tone-stat">
                        <div class="tone-label">${toneNames[i]}</div>
                        <div class="tone-bar">
                            <div class="tone-progress" style="width: ${stats.percentage}%"></div>
                        </div>
                        <div class="tone-percentage">${stats.percentage}%</div>
                    </div>`;
            }
            
            reportHTML += `
                        </div>
                    </div>
                    
                    <div class="detailed-results">
                        <h4>Question Details:</h4>
                        <div class="results-table">`;
            
            quizAnswers.forEach((answer, index) => {
                const statusIcon = answer.isCorrect ? '✅' : '❌';
                const responseTime = Math.round(answer.responseTime / 1000);
                reportHTML += `
                    <div class="result-row ${answer.isCorrect ? 'correct' : 'incorrect'}">
                        <span class="result-icon">${statusIcon}</span>
                        <span class="result-char">${answer.character}</span>
                        <span class="result-pinyin">${answer.pinyin}</span>
                        <span class="result-meaning">${answer.meaning}</span>
                        <span class="result-tone">Tone ${answer.correctTone}</span>
                        <span class="result-time">${responseTime}s</span>
                    </div>`;
            });
            
            reportHTML += `
                        </div>
                    </div>
                    
                    <div class="report-actions">
                        <button class="quiz-action-btn retry-btn" onclick="resetQuiz()">🔄 Try Again</button>
                        <button class="quiz-action-btn continue-btn" onclick="continueToLearning()">📚 Continue Learning</button>
                    </div>
                </div>
            `;
            
            const quizContent = document.getElementById('quiz-content');
            if (quizContent) {
                quizContent.innerHTML = reportHTML;
            }
        }
        
        function continueToLearning() {
            // Scroll to the tone cards section
            const tonesGrid = document.querySelector('.tones-grid');
            if (tonesGrid) {
                tonesGrid.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function resetQuiz() {
            currentQuestion = 0;
            score = 0;
            quizAnswers = [];
            quizStartTime = null;
            questionStartTime = null;
            
            // Shuffle questions for new quiz
            initializeQuiz();
            
            // Reset progress counter
            const progressDiv = document.getElementById('quiz-progress');
            if (progressDiv) {
                progressDiv.textContent = `Question 1 of ${quizData.length}`;
            }
            
            document.getElementById('quiz-content').innerHTML = `
                <div class="quiz-question" id="quiz-question">
                    Which tone does this character use: <strong id="quiz-char">妈</strong> (mother)?
                </div>
                <div class="character-display">
                    <div class="character-info">
                        <div class="big-character" id="big-char">妈</div>
                        <div class="character-pinyin" id="char-pinyin" style="display: none;">mā</div>
                        <button class="play-character-btn" id="play-char-btn" onclick="playCharacterTone()">🔊 Play Sound</button>
                    </div>
                </div>
                <div class="quiz-options" id="quiz-options">
                    <div class="quiz-option" onclick="selectAnswer(1)">1st Tone (High Level)</div>
                    <div class="quiz-option" onclick="selectAnswer(2)">2nd Tone (Rising)</div>
                    <div class="quiz-option" onclick="selectAnswer(3)">3rd Tone (Dipping)</div>
                    <div class="quiz-option" onclick="selectAnswer(4)">4th Tone (Falling)</div>
                </div>
                <div id="quiz-result" class="quiz-result" style="display: none;"></div>
                <button id="next-question" class="next-question" style="display: none;">Next Question</button>
            `;
            loadQuestion();
        }

        // Initialize the quiz
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeQuiz(); // Shuffle questions first
                loadQuestion();
                initializeWaveBars();
                updatePracticeWord();
                initToneVisualization();
                
                // Add event delegation for next question button
                document.addEventListener('click', function(event) {
                    if (event.target && event.target.id === 'next-question') {
                        console.log('Next question button clicked via event delegation');
                        nextQuestion();
                        event.preventDefault();
                    }
                });
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        });

        // Tone visualization functions
        function initToneVisualization() {
            canvas = document.getElementById('tone-canvas');
            ctx = canvas.getContext('2d');
            drawReferenceTone();
        }

        function drawReferenceTone() {
            const word = quizData[currentPracticeWord];
            const tone = word ? word.tone : 1;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            
            for (let i = 1; i < 5; i++) {
                const y = (canvas.height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(50, y);
                ctx.lineTo(canvas.width - 50, y);
                ctx.stroke();
            }
            ctx.setLineDash([]);
            
            // Draw reference tone curve
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const startX = 50;
            const endX = canvas.width - 50;
            const centerY = canvas.height / 2;
            const amplitude = canvas.height * 0.3;
            
            for (let x = startX; x <= endX; x++) {
                const progress = (x - startX) / (endX - startX);
                let y = centerY;
                
                switch(tone) {
                    case 1: // High level
                        y = centerY - amplitude * 0.5;
                        break;
                    case 2: // Rising
                        y = centerY + amplitude * 0.3 - (amplitude * 0.8 * progress);
                        break;
                    case 3: // Dipping
                        if (progress < 0.5) {
                            y = centerY - (amplitude * 0.5 * (1 - progress * 2));
                        } else {
                            y = centerY + amplitude * 0.5 - (amplitude * 0.8 * (progress - 0.5) * 2);
                        }
                        break;
                    case 4: // Falling
                        y = centerY - amplitude * 0.5 + (amplitude * 0.8 * progress);
                        break;
                }
                
                if (x === startX) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Add tone labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('High', 10, 30);
            ctx.fillText('Mid', 10, centerY + 5);
            ctx.fillText('Low', 10, canvas.height - 10);
        }

        function drawUserPitch(pitchArray) {
            if (!pitchArray || pitchArray.length < 2) return;
            
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const startX = 50;
            const endX = canvas.width - 50;
            const centerY = canvas.height / 2;
            const amplitude = canvas.height * 0.3;
            
            // Use a more stable pitch range for better visualization
            const avgPitch = pitchArray.reduce((sum, p) => sum + p, 0) / pitchArray.length;
            const pitchStdDev = Math.sqrt(pitchArray.reduce((sum, p) => sum + Math.pow(p - avgPitch, 2), 0) / pitchArray.length);
            
            // Use 2 standard deviations for range, but with minimum range
            const minRange = 50; // Hz minimum range
            const calculatedRange = Math.max(pitchStdDev * 4, minRange);
            const minPitch = avgPitch - calculatedRange / 2;
            const maxPitch = avgPitch + calculatedRange / 2;
            
            ctx.beginPath();
            
            let firstPoint = true;
            pitchArray.forEach((pitch, index) => {
                const x = startX + (index / (pitchArray.length - 1)) * (endX - startX);
                const normalizedPitch = (pitch - minPitch) / (maxPitch - minPitch);
                const y = centerY + amplitude - (normalizedPitch * amplitude * 2);
                
                if (firstPoint) {
                    ctx.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Add current pitch indicator
            if (pitchArray.length > 0) {
                const lastPitch = pitchArray[pitchArray.length - 1];
                const lastX = startX + ((pitchArray.length - 1) / (pitchArray.length - 1 || 1)) * (endX - startX);
                const lastNormalizedPitch = (lastPitch - minPitch) / (maxPitch - minPitch);
                const lastY = centerY + amplitude - (lastNormalizedPitch * amplitude * 2);
                
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(lastX, lastY, 4, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        function updateToneVisualization() {
            if (!isRecording || !analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            analyser.getFloatFrequencyData(dataArray);
            
            // Better pitch detection using autocorrelation
            const pitch = detectPitch(dataArray);
            
            if (pitch && pitch > 80 && pitch < 400) { // Human voice range
                pitchData.push(pitch);
                
                // Keep only recent pitch data (about 2 seconds worth)
                if (pitchData.length > 50) {
                    pitchData = pitchData.slice(-50);
                }
                
                // Apply smoothing to pitch data
                const smoothedPitchData = smoothPitchData(pitchData);
                
                // Redraw with user pitch
                drawReferenceTone();
                drawUserPitch(smoothedPitchData);
            }
            
            if (isRecording) {
                animationId = requestAnimationFrame(updateToneVisualization);
            }
        }

        function detectPitch(frequencyData) {
            // Convert frequency domain back to time domain for autocorrelation
            const bufferLength = frequencyData.length;
            const sampleRate = audioContext.sampleRate;
            
            // Find the peak in the frequency domain for human voice range
            let maxValue = -Infinity;
            let maxIndex = 0;
            
            // Human voice fundamental frequency is typically 80-400 Hz
            const minFreq = 80;
            const maxFreq = 400;
            const minIndex = Math.floor(minFreq * bufferLength * 2 / sampleRate);
            const maxIndexRange = Math.floor(maxFreq * bufferLength * 2 / sampleRate);
            
            for (let i = minIndex; i < Math.min(maxIndexRange, bufferLength); i++) {
                if (frequencyData[i] > maxValue && frequencyData[i] > -50) { // -50 dB threshold
                    maxValue = frequencyData[i];
                    maxIndex = i;
                }
            }
            
            if (maxValue > -40) { // Strong enough signal
                return maxIndex * sampleRate / (2 * bufferLength);
            }
            
            return null;
        }

        function smoothPitchData(data) {
            if (data.length < 3) return data;
            
            // Simple moving average smoothing
            const smoothed = [];
            const windowSize = Math.min(3, data.length);
            
            for (let i = 0; i < data.length; i++) {
                let sum = 0;
                let count = 0;
                
                for (let j = Math.max(0, i - Math.floor(windowSize/2)); 
                     j <= Math.min(data.length - 1, i + Math.floor(windowSize/2)); 
                     j++) {
                    sum += data[j];
                    count++;
                }
                
                smoothed.push(sum / count);
            }
            
            return smoothed;
        }

        // Practice tone highlighting
        document.querySelectorAll('.practice-tone').forEach(tone => {
            tone.addEventListener('click', function() {
                document.querySelectorAll('.practice-tone').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 1000);
            });
        });

        // Recording functionality
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                pitchData = [];
                
                // Set up audio analysis
                if (!audioContext) {
                    initAudio();
                }
                
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    recordedAudio = URL.createObjectURL(blob);
                    document.getElementById('play-btn').disabled = false;
                    showFeedback();
                    
                    // Stop analysis
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = '⏹️ Stop Recording';
                recordBtn.className = 'record-btn stop';
                
                document.getElementById('recording-status').textContent = 'Recording... Speak now!';
                document.getElementById('recording-status').className = 'recording-status recording';
                
                startWaveAnimation();
                updateToneVisualization();
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('recording-status').textContent = 'Error: Could not access microphone';
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                // Update UI
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = '🎤 Start Recording';
                recordBtn.className = 'record-btn start';
                
                document.getElementById('recording-status').textContent = 'Recording complete! Click play to listen.';
                document.getElementById('recording-status').className = 'recording-status';
                
                stopWaveAnimation();
            }
        }

        function playRecording() {
            if (recordedAudio) {
                const audio = new Audio(recordedAudio);
                audio.play();
                
                document.getElementById('recording-status').textContent = 'Playing back your recording...';
                
                audio.onended = () => {
                    document.getElementById('recording-status').textContent = 'Playback complete. How did you do?';
                };
            }
        }

        function nextPracticeWord() {
            currentPracticeWord = (currentPracticeWord + 1) % quizData.length;
            updatePracticeWord();
            resetRecording();
            drawReferenceTone();
        }

        function updatePracticeWord() {
            try {
                const word = quizData[currentPracticeWord];
                if (!word) return;
                
                // Check if elements exist before updating
                const charEl = document.getElementById('practice-char');
                const pinyinEl = document.getElementById('practice-pinyin');
                const meaningEl = document.getElementById('practice-meaning');
                const toneInfoEl = document.getElementById('practice-tone-info');
                
                if (charEl && word.char) charEl.textContent = word.char;
                if (pinyinEl && word.pinyin) pinyinEl.textContent = word.pinyin;
                if (meaningEl && word.meaning) meaningEl.textContent = word.meaning;
                
                if (toneInfoEl && word.tone) {
                    const toneNames = ['', 'High Level', 'Rising', 'Dipping', 'Falling'];
                    const toneName = toneNames[word.tone] || 'Unknown';
                    const suffix = getOrdinalSuffix(word.tone);
                    toneInfoEl.textContent = `${word.tone}${suffix} tone (${toneName})`;
                }
            } catch (error) {
                console.error('Error updating practice word:', error);
            }
        }

        function resetRecording() {
            if (isRecording) {
                stopRecording();
            }
            
            recordedAudio = null;
            document.getElementById('play-btn').disabled = true;
            document.getElementById('recording-status').textContent = 'Ready to record - Press the microphone button to start';
            document.getElementById('feedback').className = 'feedback-section';
        }

        function showFeedback() {
            const feedback = document.getElementById('feedback');
            const encouragements = [
                'Great job! Keep practicing to master the tones.',
                'Nice work! Try to match the pitch pattern even more closely.',
                'Good effort! Remember to start and end at the right pitch levels.',
                'Well done! Practice makes perfect with Chinese tones.',
                'Excellent! Your pronunciation is improving.'
            ];
            
            feedback.innerHTML = `<strong>Recording Complete!</strong> ${encouragements[Math.floor(Math.random() * encouragements.length)]}`;
            feedback.className = 'feedback-section good show';
            
            // Show practice report after feedback
            setTimeout(() => {
                showPracticeReport();
            }, 1000);
            
            setTimeout(() => {
                feedback.className = 'feedback-section';
            }, 5000);
        }

        function showPracticeReport() {
            const word = quizData[currentPracticeWord];
            const targetTone = word ? word.tone : 1;
            
            // Simple pitch analysis (basic implementation)
            const score = analyzePitchMatch(targetTone);
            
            // Update score display
            const scoreElement = document.getElementById('practice-score');
            if (scoreElement) {
                scoreElement.textContent = `${score}%`;
            }
            
            // Update score circle color based on performance
            const scoreCircle = document.querySelector('.practice-score-circle');
            if (scoreCircle) {
                if (score >= 80) {
                    scoreCircle.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                } else if (score >= 60) {
                    scoreCircle.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                } else {
                    scoreCircle.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                }
            }
            
            // Generate feedback message
            const feedbackText = document.getElementById('practice-feedback-text');
            if (feedbackText) {
                if (score >= 85) {
                    feedbackText.textContent = '🎉 Excellent! Your tone is very accurate!';
                    feedbackText.style.background = '#e8f5e8';
                    feedbackText.style.color = '#27ae60';
                } else if (score >= 70) {
                    feedbackText.textContent = '👍 Good job! Try to match the tone pattern more closely.';
                    feedbackText.style.background = '#fff3cd';
                    feedbackText.style.color = '#856404';
                } else if (score >= 50) {
                    feedbackText.textContent = '📚 Keep practicing! Focus on the pitch changes.';
                    feedbackText.style.background = '#fff3cd';
                    feedbackText.style.color = '#856404';
                } else {
                    feedbackText.textContent = '💪 Try again! Listen carefully to the target tone.';
                    feedbackText.style.background = '#f8d7da';
                    feedbackText.style.color = '#721c24';
                }
            }
            
            // Show the report
            const reportSection = document.getElementById('practice-report');
            if (reportSection) {
                reportSection.style.display = 'block';
                reportSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function analyzePitchMatch(targetTone) {
            // Basic pitch analysis - in a real implementation, this would analyze the recorded audio
            // For now, we'll simulate analysis based on the pitch data we collected
            
            if (!pitchData || pitchData.length === 0) {
                return Math.floor(Math.random() * 40) + 30; // Random low score if no data
            }
            
            // Simple analysis: check if pitch data has the right general trend
            const avgPitch = pitchData.reduce((sum, p) => sum + p, 0) / pitchData.length;
            let score = 50; // Base score
            
            // Analyze based on target tone pattern
            switch(targetTone) {
                case 1: // Flat tone - check consistency
                    const variance = pitchData.reduce((sum, p) => sum + Math.pow(p - avgPitch, 2), 0) / pitchData.length;
                    score = Math.max(30, 100 - Math.min(variance / 10, 70));
                    break;
                    
                case 2: // Rising tone - check if generally increasing
                    const startPitch = pitchData.slice(0, Math.floor(pitchData.length / 3)).reduce((sum, p) => sum + p, 0) / Math.floor(pitchData.length / 3);
                    const endPitch = pitchData.slice(-Math.floor(pitchData.length / 3)).reduce((sum, p) => sum + p, 0) / Math.floor(pitchData.length / 3);
                    const rise = endPitch - startPitch;
                    score = Math.max(30, 70 + Math.min(rise / 50, 30));
                    break;
                    
                case 3: // Dipping tone - check for dip pattern
                    const midIndex = Math.floor(pitchData.length / 2);
                    const midPitch = pitchData.slice(midIndex - 2, midIndex + 2).reduce((sum, p) => sum + p, 0) / 4;
                    const dipAmount = avgPitch - midPitch;
                    score = Math.max(30, 60 + Math.min(dipAmount / 30, 40));
                    break;
                    
                case 4: // Falling tone - check if generally decreasing
                    const startPitch4 = pitchData.slice(0, Math.floor(pitchData.length / 3)).reduce((sum, p) => sum + p, 0) / Math.floor(pitchData.length / 3);
                    const endPitch4 = pitchData.slice(-Math.floor(pitchData.length / 3)).reduce((sum, p) => sum + p, 0) / Math.floor(pitchData.length / 3);
                    const fall = startPitch4 - endPitch4;
                    score = Math.max(30, 70 + Math.min(fall / 50, 30));
                    break;
            }
            
            return Math.round(Math.min(100, Math.max(30, score + Math.random() * 20 - 10))); // Add some randomness
        }

        function tryAgainPractice() {
            // Hide the report and reset for another recording
            const reportSection = document.getElementById('practice-report');
            if (reportSection) {
                reportSection.style.display = 'none';
            }
            
            // Reset recording state
            resetRecording();
        }

        // Wave animation functions
        function initializeWaveBars() {
            const waveBars = document.getElementById('wave-bars');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'wave-bar';
                bar.style.height = '10px';
                waveBars.appendChild(bar);
            }
        }

        function startWaveAnimation() {
            const bars = document.querySelectorAll('.wave-bar');
            const animateWave = () => {
                if (isRecording) {
                    bars.forEach((bar, index) => {
                        const height = Math.random() * 40 + 10;
                        bar.style.height = height + 'px';
                    });
                    setTimeout(animateWave, 100);
                }
            };
            animateWave();
        }

        function stopWaveAnimation() {
            const bars = document.querySelectorAll('.wave-bar');
            bars.forEach(bar => {
                bar.style.height = '10px';
            });
        }
    </script>
</body>
</html>
